# Malware/Suspicious File Detection Scenario

## 1. Attack Overview and Real-world Context

Malware and suspicious file detection is a critical capability for any SIEM solution. Malicious software can enter an organization through various vectors including email attachments, malicious downloads, infected USB devices, or compromised websites. Once inside the network, malware can steal data, encrypt files for ransom, establish persistence, or create backdoors for attackers.

### Real-world Context

Malware attacks remain one of the most common and damaging cyber threats:
- The 2017 WannaCry ransomware attack affected over 200,000 computers across 150 countries
- NotPetya caused an estimated $10 billion in damages globally
- Supply chain attacks like SolarWinds demonstrated how malware can be distributed through trusted software updates
- Emotet, one of the most persistent malware families, continues to evolve and spread through sophisticated phishing campaigns

Early detection of malicious files and suspicious activities is essential for preventing widespread damage and data loss.

## 2. Environment Setup Requirements

### Prerequisites

- Functioning Elastic Stack SIEM deployment as described in the [Deployment Guide](../docker/DEPLOYMENT.md)
- Configured data pipelines for endpoint logs and file events
- Configured detection rules for suspicious file activities
- A test system with Auditbeat and/or Winlogbeat installed (can be a Docker container or VM)
- YARA rules for malware detection (optional but recommended)

### Test Environment Setup

1. Create a test environment using Docker:

```bash
# Create a test container
docker run -d --name malware-test ubuntu:latest sleep infinity
```

2. Install monitoring agents in the test environment:

```bash
# For Linux test environment
docker exec -it malware-test apt-get update
docker exec -it malware-test apt-get install -y curl
docker exec -it malware-test bash -c "curl -L -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.12.2-amd64.deb"
docker exec -it malware-test bash -c "dpkg -i auditbeat-8.12.2-amd64.deb"
```

3. Configure Auditbeat for file integrity monitoring:

```bash
docker exec -it malware-test bash -c "cat > /etc/auditbeat/auditbeat.yml << 'EOF'
auditbeat.modules:
- module: file_integrity
  paths:
  - /tmp
  - /var/www/html
  - /etc
  - /bin
  - /usr/bin
  scan_at_start: true
  scan_rate_per_sec: 50 MiB
  max_file_size: 100 MiB
  hash_types: [sha1, sha256]
  recursive: true

output.elasticsearch:
  hosts: ['elasticsearch:9200']
  username: 'elastic'
  password: 'changeme'

setup.kibana:
  host: 'kibana:5601'
EOF"
```

4. Configure the Malware Detection rule in Kibana:
   - Navigate to **Security** > **Detections** > **Manage detection rules**
   - Create a rule with the following settings:
     - Name: `Suspicious File Detection`
     - Description: `Detects potentially malicious files based on file characteristics and behavior`
     - Index pattern: `auditbeat-*`
     - Query: `event.module:file_integrity AND event.action:(created OR updated) AND file.extension:(exe OR dll OR ps1 OR bat OR sh)`
     - Schedule: Run every 5 minutes

## 3. Attack Execution Steps

### Method 1: Creating a Simulated Malware File

1. Create a harmless file that mimics malware characteristics:

```bash
docker exec -it malware-test bash -c "cat > /tmp/suspicious_file.sh << 'EOF'
#!/bin/bash
# This is a simulated malicious script for testing purposes
# It doesn't actually do anything harmful

echo "Starting malicious activities..."
echo "Scanning for sensitive files..."
find /home -name "*.txt" 2>/dev/null
echo "Attempting to modify system files..."
touch /tmp/.hidden_file
echo "Establishing connection to command and control server..."
ping -c 1 example.com
echo "Malicious activities completed."
EOF"
```

2. Make the file executable:

```bash
docker exec -it malware-test chmod +x /tmp/suspicious_file.sh
```

3. Create a suspicious Windows-style executable (for demonstration):

```bash
docker exec -it malware-test bash -c "dd if=/dev/urandom of=/tmp/malware.exe bs=1024 count=100"
```

### Method 2: Using EICAR Test File

The EICAR test file is a standard test file used to verify antivirus software without using actual malware:

```bash
docker exec -it malware-test bash -c "echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/eicar.com"
```

### Method 3: Simulating Suspicious Behavior

1. Create a script that simulates suspicious behavior:

```bash
docker exec -it malware-test bash -c "cat > /tmp/suspicious_behavior.sh << 'EOF'
#!/bin/bash
# This script simulates suspicious behavior for SIEM detection testing

# Create multiple random executable files
for i in {1..5}; do
  dd if=/dev/urandom of=/tmp/suspicious_$i.exe bs=1024 count=$((100 + $i * 10))
done

# Create hidden directories
mkdir -p /tmp/.hidden_dir

# Modify system files (simulation only)
touch /tmp/passwd.bak
touch /tmp/shadow.bak

# Execute commands with encoded arguments (common in malware)
echo "ZWNobyAiVGhpcyBpcyBhbiBlbmNvZGVkIGNvbW1hbmQiCg==" | base64 -d | bash

# Simulate network connections to suspicious domains
echo "Connecting to malicious-domain.example.com" > /tmp/network.log
echo "Connecting to c2-server.example.net" >> /tmp/network.log

echo "Suspicious behavior simulation completed."
EOF"
```

2. Make the script executable and run it:

```bash
docker exec -it malware-test chmod +x /tmp/suspicious_behavior.sh
docker exec -it malware-test /tmp/suspicious_behavior.sh
```

## 4. Expected Detection Outcomes

### Alerts

The Elastic Stack SIEM should generate alerts based on the configured detection rules when:
- Suspicious files are created or modified in monitored directories
- Files with potentially dangerous extensions are detected
- Unusual file operations occur in sensitive system directories
- Files matching known malware signatures are detected (if using YARA rules)

### Dashboard Visualization

The following visualizations should reflect the malware/suspicious file activity:
- **File Events Over Time**: Should show spikes during the attack simulation
- **Top File Extensions**: Should include suspicious extensions like .exe, .sh
- **File Operations by Directory**: Should highlight activity in sensitive directories
- **Suspicious Process Executions**: Should show execution of the suspicious scripts

### Timeline

The SIEM timeline should show:
1. Creation of suspicious files
2. Execution of suspicious scripts
3. Modification of sensitive files or directories
4. Network connection attempts (if monitored)

## 5. Validation Methods

### Verify Alert Generation

1. Navigate to **Security** > **Alerts** in Kibana
2. Confirm that a "Suspicious File Detection" alert was generated
3. Verify that the alert contains:
   - The correct file paths
   - The file hashes (if available)
   - The user who created/modified the files
   - The correct timestamp range

### Verify Log Collection

1. Navigate to **Discover** in Kibana
2. Select the `auditbeat-*` index pattern
3. Search for `event.module:file_integrity AND file.path:"/tmp/suspicious*"`
4. Verify that the file events were properly collected and indexed

### Verify File Integrity Monitoring

1. Navigate to **Security** > **Hosts** > **Events** in Kibana
2. Filter for `event.module:file_integrity`
3. Verify that file creation, modification, and deletion events are being captured

## 6. Remediation Recommendations

Based on the detection of suspicious files, the following remediation steps are recommended:

### Immediate Actions

1. **Isolate the affected system**:
   ```bash
   # Disconnect from network or isolate via firewall
   sudo iptables -A INPUT -d <affected_host_ip> -j DROP
   sudo iptables -A OUTPUT -s <affected_host_ip> -j DROP
   ```

2. **Stop suspicious processes**:
   ```bash
   # Find and kill suspicious processes
   ps aux | grep suspicious
   kill -9 <process_id>
   ```

3. **Quarantine suspicious files**:
   ```bash
   # Move suspicious files to a quarantine directory
   mkdir -p /quarantine
   mv /tmp/suspicious* /quarantine/
   chmod 000 /quarantine/*
   ```

### Long-term Mitigations

1. **Implement application whitelisting**:
   - Use tools like AppArmor or SELinux to restrict which applications can run
   - Example AppArmor profile:
     ```
     /usr/bin/firefox {
       /usr/lib/** mr,
       /lib/** mr,
       /usr/bin/firefox r,
       /home/*/.mozilla/** rw,
       deny /etc/shadow r,
       deny /tmp/** w,
     }
     ```

2. **Enhance file integrity monitoring**:
   - Expand Auditbeat coverage to additional critical directories
   - Implement real-time alerting for changes to system binaries

3. **Implement endpoint protection**:
   - Deploy an endpoint protection platform (EPP) with anti-malware capabilities
   - Consider using Elastic Endpoint Security for integrated protection

4. **Regular system scanning**:
   - Implement regular malware scans using tools like ClamAV
   - Example cron job:
     ```
     0 2 * * * /usr/bin/clamscan -r --quiet --infected /home /var/www /tmp
     ```

## 7. Additional Resources

- [MITRE ATT&CK Framework - Malware](https://attack.mitre.org/tactics/TA0002/)
- [OWASP Malicious File Mitigation](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [CIS Controls for Malware Defense](https://www.cisecurity.org/controls/malware-defenses)
- [Elastic Security Labs - Malware Analysis](https://www.elastic.co/security-labs/malware-analysis)

## 8. Conclusion

This scenario demonstrates how the Elastic Stack SIEM can detect potentially malicious files and suspicious file activities through file integrity monitoring, log analysis, and alerting. By implementing proper detection rules and monitoring visualizations, security teams can quickly identify and respond to potential malware infections before they cause significant damage.

The detection capabilities demonstrated in this scenario can be enhanced by integrating additional security tools such as antivirus solutions, YARA rules for custom malware detection, and sandbox environments for dynamic analysis of suspicious files.

